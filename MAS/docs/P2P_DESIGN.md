# P2P客户端通信设计文档

## 概述

方案B使用P2P直连方式，让Flutter客户端之间直接通信，服务器仅用于：
1. 设备发现和注册
2. NAT穿透协助（STUN功能）
3. 作为备用中继（当P2P连接失败时）

## 技术架构

### 1. 设备发现流程
```
客户端A → 服务器：注册（包含本地IP、端口）
服务器 → 所有客户端：广播设备列表
客户端B → 服务器：获取客户端A的连接信息
```

### 2. P2P连接建立
```
步骤1：交换连接信息
客户端A ← 服务器 → 客户端B

步骤2：NAT打洞
客户端A → 客户端B：UDP打洞包
客户端B → 客户端A：UDP打洞包

步骤3：建立连接
客户端A ←TCP→ 客户端B
```

### 3. 消息传输
- 使用TCP确保可靠传输
- JSON格式的消息协议
- 端到端加密（可选）

## 实现组件

### 服务器端
1. **P2P协调服务** (`p2p_coordinator_service.py`)
   - 管理设备的P2P连接信息
   - 协助NAT穿透
   - 提供STUN服务

2. **P2P API路由** (`p2p.py`)
   - `/api/p2p/register` - 注册P2P端点
   - `/api/p2p/peers` - 获取可连接的对等设备
   - `/api/p2p/punch` - 协助NAT打洞

### Flutter客户端
1. **P2P连接管理器**
   - 管理与其他设备的直接连接
   - 处理NAT穿透
   - 消息收发

2. **本地消息存储**
   - SQLite存储聊天记录
   - 离线消息缓存

## 优势
- 低延迟（直接连接）
- 隐私保护（端到端）
- 减少服务器负载
- 支持局域网内高速传输

## 挑战与解决方案

### 1. NAT穿透
**问题**：大多数设备在NAT后面
**解决**：
- UDP打洞技术
- 服务器协助的连接建立
- 备用的服务器中继

### 2. 连接稳定性
**问题**：移动网络不稳定
**解决**：
- 自动重连机制
- 多路径传输
- 消息队列和重试

### 3. 安全性
**问题**：直接连接可能有安全风险
**解决**：
- 设备认证
- 消息加密
- 连接白名单

## 实施步骤

### Phase 1：基础P2P（局域网）
1. 扩展设备发现服务
2. 实现局域网内P2P连接
3. 基本消息传输

### Phase 2：广域网支持
1. 实现NAT穿透
2. STUN服务
3. 连接协商

### Phase 3：高级功能
1. 端到端加密
2. 文件传输
3. 群组通信
